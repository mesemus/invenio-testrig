name: 'Run Tests'
description: 'Run tests in a package repository and record results'
inputs:
  package-path:
    description: 'Path to the package directory containing .venv'
    required: true
  package-name:
    description: 'Name of the package being tested'
    required: true
  test-type:
    description: 'Type of test run (original or patched)'
    required: true
  timeout:
    description: 'Timeout in seconds for test execution (0 = no timeout)'
    required: false
    default: '3600'
outputs:
  conclusion:
    description: 'Test conclusion (success or failure)'
    value: ${{ steps.run-tests.outputs.conclusion }}
runs:
  using: 'composite'
  steps:
    - name: Run tests on ${{ inputs.test-type }} package
      id: run-tests
      shell: bash
      run: |
        echo "SO_FAR_OK=0" >> $GITHUB_ENV
        cd ${{ inputs.package-path }}
        source .venv/bin/activate

        # Create artifacts directory
        mkdir -p ../artifacts

        TIMEOUT=${{ inputs.timeout }}
        TIMEOUT_TRIGGERED=0

        # Start timeout watchdog in background if timeout is set
        if [ "$TIMEOUT" -gt 0 ]; then
          (
            sleep "$TIMEOUT"
            echo ""
            echo "â±ï¸  Test execution exceeded timeout of ${TIMEOUT} seconds"
            echo "ðŸ”´ Killing all Python processes..."
            # Kill all python processes
            killall -9 python || true
            killall -9 python3 || true
            # Create a marker file to indicate timeout
            touch ../artifacts/timeout-triggered-${{ inputs.test-type }}.marker
          ) &
          WATCHDOG_PID=$!
          echo "Started timeout watchdog (PID: $WATCHDOG_PID) with ${TIMEOUT}s timeout"
        fi

        echo "ðŸ§ª Running tests on ${{ inputs.test-type }} package"
        echo "::group::Test execution (${{ inputs.test-type }})"
        set +e
        bash run-tests.sh 2>&1 | tee ../artifacts/test-output-${{ inputs.test-type }}.txt
        TEST_EXIT_CODE=${PIPESTATUS[0]}
        set -e
        echo "::endgroup::"

        # Kill the watchdog if it's still running
        if [ "$TIMEOUT" -gt 0 ] && [ -n "$WATCHDOG_PID" ]; then
          if kill -0 "$WATCHDOG_PID" 2>/dev/null; then
            kill "$WATCHDOG_PID" 2>/dev/null || true
            echo "âœ“ Stopped timeout watchdog"
          fi
        fi

        # Check if timeout was triggered
        if [ -f ../artifacts/timeout-triggered-${{ inputs.test-type }}.marker ]; then
          TIMEOUT_TRIGGERED=1
          echo "" >> ../artifacts/test-output-${{ inputs.test-type }}.txt
          echo "========================================" >> ../artifacts/test-output-${{ inputs.test-type }}.txt
          echo "â±ï¸  TIMEOUT: Test execution exceeded ${TIMEOUT} seconds" >> ../artifacts/test-output-${{ inputs.test-type }}.txt
          echo "ðŸ”´ All Python processes were terminated" >> ../artifacts/test-output-${{ inputs.test-type }}.txt
          echo "========================================" >> ../artifacts/test-output-${{ inputs.test-type }}.txt
        fi

        if [ $TEST_EXIT_CODE -ne 0 ] || [ $TIMEOUT_TRIGGERED -eq 1 ]; then
          if [ $TIMEOUT_TRIGGERED -eq 1 ]; then
            echo "âŒ Tests failed due to timeout (${TIMEOUT}s)"
          else
            echo "âŒ Tests failed (exit code: $TEST_EXIT_CODE)"
          fi
          echo "failed" > ../artifacts/test-status-${{ inputs.test-type }}.txt
          echo "conclusion=failure" >> $GITHUB_OUTPUT
        else
          echo "âœ“ Tests passed"
          echo "success" > ../artifacts/test-status-${{ inputs.test-type }}.txt
          echo "conclusion=success" >> $GITHUB_OUTPUT
        fi
        echo "SO_FAR_OK=1" >> $GITHUB_ENV
