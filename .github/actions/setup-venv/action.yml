name: 'Setup Virtual Environment'
description: 'Create a virtual environment and install package dependencies'
inputs:
  package-path:
    description: 'Path to the package directory'
    required: true
  package-name:
    description: 'Name of the package being tested'
    required: true
  requirement-type:
    description: 'Type of requirements (original or patched)'
    required: true
  extras:
    description: 'Comma-separated list of package extras to install'
    required: false
    default: 'tests,opensearch2,s3,devs,s3fs,oaipmh,rdf,sparql,postgresql,admin,docs'
  python-version:
    description: 'Python version to use for the virtual environment'
    required: true
runs:
  using: 'composite'
  steps:
    - name: Create virtual environment
      shell: bash
      run: |
        echo "SO_FAR_OK=0" >> $GITHUB_ENV
        cd ${{ inputs.package-path }}
        echo "ðŸ”§ Setting up virtual environment and installing dependencies"
        echo "::group::Creating virtual environment"
        uv venv --seed --python ${{ inputs.python-version }} .venv
        echo "::endgroup::"
        source .venv/bin/activate

        # Install the package with test dependencies
        echo "::group::Installing package with dependencies"
        uv pip install -e ".[${{ inputs.extras }}]"
        echo "::endgroup::"
        echo "âœ“ Virtual environment created and dependencies installed"
        echo "SO_FAR_OK=1" >> $GITHUB_ENV
    
    - name: Dump requirements
      shell: bash
      run: |
        artifacts_dir="$PWD/artifacts"
        cd ${{ inputs.package-path }}
        source .venv/bin/activate
        
        # Create artifacts directory
        mkdir -p $artifacts_dir
        
        # Dump requirements to file
        echo "ðŸ“ Dumping requirements to $artifacts_dir/requirements-${{ inputs.requirement-type }}.txt"
        uv pip freeze > $artifacts_dir/requirements-${{ inputs.requirement-type }}.txt
        echo "âœ“ Requirements dumped"
