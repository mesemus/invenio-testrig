<?xml version="1.0" encoding="utf-8"?><testsuites name="pytest tests"><testsuite name="pytest" errors="0" failures="9" skipped="0" tests="100" time="10.458" timestamp="2025-11-18T11:38:32.370410+00:00" hostname="runnervmg1sw1"><testcase classname="docs.conf" name="PYDOCSTYLE" time="0.012" /><testcase classname="docs.conf" name="ISORT" time="0.154" /><testcase classname="docs.conf" name="black" time="0.369" /><testcase classname="tests.conftest" name="PYDOCSTYLE" time="0.014" /><testcase classname="tests.conftest" name="ISORT" time="0.029" /><testcase classname="tests.conftest" name="black" time="0.175" /><testcase classname="tests.data.__init__" name="PYDOCSTYLE" time="0.003" /><testcase classname="tests.data.__init__" name="ISORT" time="0.004" /><testcase classname="tests.data.__init__" name="black" time="0.194" /><testcase classname="tests.data.os-v1.__init__" name="PYDOCSTYLE" time="0.002" /><testcase classname="tests.data.os-v1.__init__" name="ISORT" time="0.004" /><testcase classname="tests.data.os-v1.__init__" name="black" time="0.166" /><testcase classname="tests.data.os-v2.__init__" name="PYDOCSTYLE" time="0.002" /><testcase classname="tests.data.os-v2.__init__" name="ISORT" time="0.004" /><testcase classname="tests.data.os-v2.__init__" name="black" time="0.161" /><testcase classname="tests.data.v7.__init__" name="PYDOCSTYLE" time="0.002" /><testcase classname="tests.data.v7.__init__" name="ISORT" time="0.004" /><testcase classname="tests.data.v7.__init__" name="black" time="0.163" /><testcase classname="tests.demo.__init__" name="PYDOCSTYLE" time="0.002" /><testcase classname="tests.demo.__init__" name="ISORT" time="0.004" /><testcase classname="tests.demo.__init__" name="black" time="0.175" /><testcase classname="tests.demo.json_resolver" name="PYDOCSTYLE" time="0.003" /><testcase classname="tests.demo.json_resolver" name="ISORT" time="0.007" /><testcase classname="tests.demo.json_resolver" name="black" time="0.166" /><testcase classname="tests.test_api" name="ISORT" time="0.073" /><testcase classname="tests.test_api" name="black" time="0.278" /><testcase classname="tests.test_api" name="test_indexer_bulk_index" time="0.196" /><testcase classname="tests.test_api" name="test_delete_action" time="0.143" /><testcase classname="tests.test_api" name="test_index_action" time="0.125"><failure message="ValueError: Not naive datetime (tzinfo is already set)">app = &lt;Flask 'testapp'&gt;

    def test_index_action(app):
        """Test index action."""
        with app.app_context():
            record = Record.create({"title": "Test"})
            db.session.commit()
    
            def receiver(sender, json=None, record=None, arguments=None, **kwargs):
                json["extra"] = "extra"
                arguments["pipeline"] = "foobar"
    
            with before_record_index.connected_to(receiver):
&gt;               action = RecordIndexer()._index_action(
                    dict(
                        id=str(record.id),
                        op="index",
                    )
                )

app        = &lt;Flask 'testapp'&gt;
receiver   = &lt;function test_index_action.&lt;locals&gt;.receiver at 0x7f9c32e8b1a0&gt;
record     = {'title': 'Test'}

tests/test_api.py:107: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_indexer/api.py:419: in _index_action
    body = self._prepare_record(record, index, arguments)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        arguments  = {}
        index      = 'records-default-v1.0.0'
        payload    = {'id': 'f0e8cc4d-a29c-4792-a7a1-be95dc70f716', 'op': 'index'}
        record     = {'title': 'Test'}
        self       = &lt;invenio_indexer.api.RecordIndexer object at 0x7f9c32fcbd70&gt;
invenio_indexer/api.py:472: in _prepare_record
    pytz.utc.localize(record.created).isoformat() if record.created else None
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        arguments  = {}
        data       = {'title': 'Test'}
        index      = 'records-default-v1.0.0'
        kwargs     = {}
        record     = {'title': 'Test'}
        self       = &lt;invenio_indexer.api.RecordIndexer object at 0x7f9c32fcbd70&gt;
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = &lt;UTC&gt;
dt = datetime.datetime(2025, 11, 18, 11, 38, 35, 671944, tzinfo=datetime.timezone.utc)
is_dst = False

    def localize(self, dt, is_dst=False):
        '''Convert naive time to local time'''
        if dt.tzinfo is not None:
&gt;           raise ValueError('Not naive datetime (tzinfo is already set)')
E           ValueError: Not naive datetime (tzinfo is already set)

dt         = datetime.datetime(2025, 11, 18, 11, 38, 35, 671944, tzinfo=datetime.timezone.utc)
is_dst     = False
self       = &lt;UTC&gt;

.venv/lib/python3.12/site-packages/pytz/__init__.py:245: ValueError</failure></testcase><testcase classname="tests.test_api" name="test_process_bulk_queue" time="0.146"><failure message="assert 1 == 2&#10; +  where 1 = process_bulk_queue()&#10; +    where process_bulk_queue = &lt;invenio_indexer.api.RecordIndexer object at 0x7f9c32ea9340&gt;.process_bulk_queue&#10; +      where &lt;invenio_indexer.api.RecordIndexer object at 0x7f9c32ea9340&gt; = RecordIndexer()">app = &lt;Flask 'testapp'&gt;
queue = &lt;unbound Queue indexer -&gt; &lt;unbound Exchange indexer(direct)&gt; -&gt; indexer&gt;

    def test_process_bulk_queue(app, queue):
        """Test process indexing."""
        with app.app_context():
            # Create a test record
            r = Record.create({"title": "test"})
            db.session.commit()
            invalid_id2 = uuid.uuid4()
    
            RecordIndexer().bulk_index([r.id, invalid_id2])
            RecordIndexer().bulk_delete([r.id, invalid_id2])
    
            ret = {}
    
            def _mock_bulk(client, actions_iterator, **kwargs):
                ret["actions"] = list(actions_iterator)
                return len(ret["actions"])
    
            with patch("invenio_indexer.api.bulk", _mock_bulk):
                # Invalid actions are rejected
&gt;               assert RecordIndexer().process_bulk_queue() == 2
E               assert 1 == 2
E                +  where 1 = process_bulk_queue()
E                +    where process_bulk_queue = &lt;invenio_indexer.api.RecordIndexer object at 0x7f9c32ea9340&gt;.process_bulk_queue
E                +      where &lt;invenio_indexer.api.RecordIndexer object at 0x7f9c32ea9340&gt; = RecordIndexer()

_mock_bulk = &lt;function test_process_bulk_queue.&lt;locals&gt;._mock_bulk at 0x7f9c32fe7920&gt;
app        = &lt;Flask 'testapp'&gt;
invalid_id2 = UUID('a9d9337b-e7f3-430b-9c73-167c085a9a54')
queue      = &lt;unbound Queue indexer -&gt; &lt;unbound Exchange indexer(direct)&gt; -&gt; indexer&gt;
r          = {'title': 'test'}
ret        = {'actions': [{'_id': '9412c3ee-d2f9-4ce7-9a17-71e630ba7d1b',
              '_index': 'records-default-v1.0.0',
              '_op_type': 'delete',
              '_version': 0,
              '_version_type': 'external_gte'}]}

tests/test_api.py:142: AssertionError</failure></testcase><testcase classname="tests.test_api" name="test_process_bulk_queue_errors" time="0.161"><failure message="assert 0 == 1&#10; +  where 0 = process_bulk_queue()&#10; +    where process_bulk_queue = &lt;invenio_indexer.api.RecordIndexer object at 0x7f9c32eabad0&gt;.process_bulk_queue&#10; +      where &lt;invenio_indexer.api.RecordIndexer object at 0x7f9c32eabad0&gt; = RecordIndexer()">app = &lt;Flask 'testapp'&gt;
queue = &lt;unbound Queue indexer -&gt; &lt;unbound Exchange indexer(direct)&gt; -&gt; indexer&gt;

    def test_process_bulk_queue_errors(app, queue):
        """Test error handling during indexing."""
        with app.app_context():
            # Create a test record
            r1 = Record.create({"title": "invalid", "reffail": {"$ref": "#/invalid"}})
            r2 = Record.create(
                {
                    "title": "valid",
                }
            )
            db.session.commit()
    
            RecordIndexer().bulk_index([r1.id, r2.id])
    
            ret = {}
    
            def _mock_bulk(client, actions_iterator, **kwargs):
                ret["actions"] = list(actions_iterator)
                return len(ret["actions"])
    
            with patch("invenio_indexer.api.bulk", _mock_bulk):
                # Exceptions are caught
&gt;               assert RecordIndexer().process_bulk_queue() == 1
E               assert 0 == 1
E                +  where 0 = process_bulk_queue()
E                +    where process_bulk_queue = &lt;invenio_indexer.api.RecordIndexer object at 0x7f9c32eabad0&gt;.process_bulk_queue
E                +      where &lt;invenio_indexer.api.RecordIndexer object at 0x7f9c32eabad0&gt; = RecordIndexer()

_mock_bulk = &lt;function test_process_bulk_queue_errors.&lt;locals&gt;._mock_bulk at 0x7f9c32df5d00&gt;
app        = &lt;Flask 'testapp'&gt;
queue      = &lt;unbound Queue indexer -&gt; &lt;unbound Exchange indexer(direct)&gt; -&gt; indexer&gt;
r1         = {'reffail': {'$ref': '#/invalid'}, 'title': 'invalid'}
r2         = {'title': 'valid'}
ret        = {'actions': []}

tests/test_api.py:168: AssertionError</failure></testcase><testcase classname="tests.test_api" name="test_index" time="0.117"><failure message="ValueError: Not naive datetime (tzinfo is already set)">app = &lt;Flask 'testapp'&gt;

    def test_index(app):
        """Test record indexing."""
        with app.app_context():
            recid = uuid.uuid4()
            record = Record.create({"title": "Test"}, id_=recid)
            db.session.commit()
    
            client_mock = MagicMock()
&gt;           RecordIndexer(search_client=client_mock, version_type="force").index(
                record, arguments={"pipeline": "foobar"}
            )

app        = &lt;Flask 'testapp'&gt;
client_mock = &lt;MagicMock id='140308844967408'&gt;
recid      = UUID('91bd28e1-05f6-4507-bfb0-c07e796e0a96')
record     = {'title': 'Test'}

tests/test_api.py:181: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_indexer/api.py:178: in index
    body = self._prepare_record(record, index, arguments, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        arguments  = {'pipeline': 'foobar'}
        index      = 'records-default-v1.0.0'
        kwargs     = {}
        record     = {'title': 'Test'}
        self       = &lt;invenio_indexer.api.RecordIndexer object at 0x7f9c32d51880&gt;
invenio_indexer/api.py:472: in _prepare_record
    pytz.utc.localize(record.created).isoformat() if record.created else None
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        arguments  = {'pipeline': 'foobar'}
        data       = {'title': 'Test'}
        index      = 'records-default-v1.0.0'
        kwargs     = {}
        record     = {'title': 'Test'}
        self       = &lt;invenio_indexer.api.RecordIndexer object at 0x7f9c32d51880&gt;
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = &lt;UTC&gt;
dt = datetime.datetime(2025, 11, 18, 11, 38, 36, 265222, tzinfo=datetime.timezone.utc)
is_dst = False

    def localize(self, dt, is_dst=False):
        '''Convert naive time to local time'''
        if dt.tzinfo is not None:
&gt;           raise ValueError('Not naive datetime (tzinfo is already set)')
E           ValueError: Not naive datetime (tzinfo is already set)

dt         = datetime.datetime(2025, 11, 18, 11, 38, 36, 265222, tzinfo=datetime.timezone.utc)
is_dst     = False
self       = &lt;UTC&gt;

.venv/lib/python3.12/site-packages/pytz/__init__.py:245: ValueError</failure></testcase><testcase classname="tests.test_api" name="test_refresh_with_indexer" time="0.093" /><testcase classname="tests.test_api" name="test_refresh_with_indexer_and_prefix" time="0.095" /><testcase classname="tests.test_api" name="test_refresh_with_index_name" time="0.157" /><testcase classname="tests.test_api" name="test_refresh_with_index_obj" time="0.087" /><testcase classname="tests.test_api" name="test_delete" time="0.130" /><testcase classname="tests.test_api" name="test_replace_refs" time="0.093" /><testcase classname="tests.test_api" name="test_bulkrecordindexer_index_delete_by_record_id" time="0.108" /><testcase classname="tests.test_api" name="test_bulkrecordindexer_index_delete_by_record" time="0.128" /><testcase classname="tests.test_api" name="test_before_record_index_dynamic_connect" time="0.129"><failure message="ValueError: Not naive datetime (tzinfo is already set)">app = &lt;Flask 'testapp'&gt;

    def test_before_record_index_dynamic_connect(app):
        """Test before_record_index.dynamic_connect."""
        with app.app_context():
            with patch("invenio_records.api._records_state.validate"):
                auth_record = Record.create(
                    {
                        "$schema": "/records/authorities/authority-v1.0.0.json",
                        "title": "Test",
                    }
                )
                bib_record = Record.create(
                    {
                        "$schema": "/records/bibliographic/bibliographic-v1.0.0.json",
                        "title": "Test",
                    }
                )
                db.session.commit()
    
            def _simple(sender, json=None, **kwargs):
                json["simple"] = "simple"
    
            def _custom(sender, json=None, **kwargs):
                json["custom"] = "custom"
    
            def _cond(sender, connect_kwargs, index=None, **kwargs):
                return "bibliographic" in index
    
            _receiver1 = before_record_index.dynamic_connect(
                _simple, index="records-authorities-authority-v1.0.0"
            )
            _receiver2 = before_record_index.dynamic_connect(_custom, condition_func=_cond)
    
&gt;           action = RecordIndexer()._index_action(dict(id=str(auth_record.id), op="index"))
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

_cond      = &lt;function test_before_record_index_dynamic_connect.&lt;locals&gt;._cond at 0x7f9c32db9d00&gt;
_custom    = &lt;function test_before_record_index_dynamic_connect.&lt;locals&gt;._custom at 0x7f9c33449760&gt;
_receiver1 = &lt;function _with_dynamic_connect.&lt;locals&gt;._dynamic_connect.&lt;locals&gt;._conditional_receiver at 0x7f9c32db9bc0&gt;
_receiver2 = &lt;function _with_dynamic_connect.&lt;locals&gt;._dynamic_connect.&lt;locals&gt;._conditional_receiver at 0x7f9c32de0fe0&gt;
_simple    = &lt;function test_before_record_index_dynamic_connect.&lt;locals&gt;._simple at 0x7f9c32e8aac0&gt;
app        = &lt;Flask 'testapp'&gt;
auth_record = {'$schema': '/records/authorities/authority-v1.0.0.json', 'title': 'Test'}
bib_record = {'$schema': '/records/bibliographic/bibliographic-v1.0.0.json', 'title': 'Test'}

tests/test_api.py:393: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_indexer/api.py:419: in _index_action
    body = self._prepare_record(record, index, arguments)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        arguments  = {}
        index      = 'records-authorities-authority-v1.0.0'
        payload    = {'id': 'b69b0381-a28c-4b1a-8cf2-98b48840e1e7', 'op': 'index'}
        record     = {'$schema': '/records/authorities/authority-v1.0.0.json', 'title': 'Test'}
        self       = &lt;invenio_indexer.api.RecordIndexer object at 0x7f9c337b7110&gt;
invenio_indexer/api.py:472: in _prepare_record
    pytz.utc.localize(record.created).isoformat() if record.created else None
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        arguments  = {}
        data       = {'$schema': '/records/authorities/authority-v1.0.0.json', 'title': 'Test'}
        index      = 'records-authorities-authority-v1.0.0'
        kwargs     = {}
        record     = {'$schema': '/records/authorities/authority-v1.0.0.json', 'title': 'Test'}
        self       = &lt;invenio_indexer.api.RecordIndexer object at 0x7f9c337b7110&gt;
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = &lt;UTC&gt;
dt = datetime.datetime(2025, 11, 18, 11, 38, 37, 323170, tzinfo=datetime.timezone.utc)
is_dst = False

    def localize(self, dt, is_dst=False):
        '''Convert naive time to local time'''
        if dt.tzinfo is not None:
&gt;           raise ValueError('Not naive datetime (tzinfo is already set)')
E           ValueError: Not naive datetime (tzinfo is already set)

dt         = datetime.datetime(2025, 11, 18, 11, 38, 37, 323170, tzinfo=datetime.timezone.utc)
is_dst     = False
self       = &lt;UTC&gt;

.venv/lib/python3.12/site-packages/pytz/__init__.py:245: ValueError</failure></testcase><testcase classname="tests.test_api" name="test_indexer_record_class" time="0.001" /><testcase classname="tests.test_cli" name="ISORT" time="0.039" /><testcase classname="tests.test_cli" name="black" time="0.216" /><testcase classname="tests.test_cli" name="test_run" time="0.175" /><testcase classname="tests.test_cli" name="test_reindex" time="0.176"><failure message="opensearchpy.exceptions.NotFoundError: NotFoundError(404, 'index_not_found_exception', 'no such index [records-default-v1.0.0]', records-default-v1.0.0, index_or_alias)">app = &lt;Flask 'testapp'&gt;

    def test_reindex(app):
        """Test reindex."""
        # load records
        with app.test_request_context():
            runner = app.test_cli_runner()
    
            id1 = uuid.uuid4()
            id2 = uuid.uuid4()
            record1 = Record.create(dict(title="Test 1", recid=1), id_=id1)
            record2 = Record.create(dict(title="Test 2", recid=2), id_=id2)
            PersistentIdentifier.create(
                pid_type="recid",
                pid_value=1,
                object_type="rec",
                object_uuid=id1,
                status=PIDStatus.REGISTERED,
            )
            PersistentIdentifier.create(
                pid_type="recid",
                pid_value=2,
                object_type="rec",
                object_uuid=id2,
                status=PIDStatus.REGISTERED,
            )
            db.session.commit()
            indexer = RecordIndexer()
            index = indexer.record_to_index(record1)
    
            # Make sure the index doesn't exist at the beginning (it was not
            # preserved by accident from some other tests)
            assert current_search_client.indices.exists(index) is False
    
            # Initialize queue
            res = runner.invoke(cli.queue, ["init", "purge"])
            assert 0 == res.exit_code
    
            res = runner.invoke(cli.reindex, ["--yes-i-know", "-t", "recid"])
            assert 0 == res.exit_code
            res = runner.invoke(cli.run, [])
            assert 0 == res.exit_code
&gt;           current_search.flush_and_refresh(index)

app        = &lt;Flask 'testapp'&gt;
id1        = UUID('b2a2d5bf-d267-490f-9fce-13f18418a0eb')
id2        = UUID('f8a28d4f-ac37-485c-bb2a-cc5efb37757e')
index      = 'records-default-v1.0.0'
indexer    = &lt;invenio_indexer.api.RecordIndexer object at 0x7f9c32d27860&gt;
record1    = {'recid': 1, 'title': 'Test 1'}
record2    = {'recid': 2, 'title': 'Test 2'}
res        = &lt;Result okay&gt;
runner     = &lt;flask.testing.FlaskCliRunner object at 0x7f9c32da5c10&gt;

tests/test_cli.py:79: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.12/site-packages/invenio_search/ext.py:249: in flush_and_refresh
    self.client.indices.flush(wait_if_ongoing=True, index=prefixed_index)
        index      = 'records-default-v1.0.0'
        prefixed_index = 'records-default-v1.0.0'
        self       = &lt;invenio_search.ext._SearchState object at 0x7f9c32d50980&gt;
.venv/lib/python3.12/site-packages/opensearchpy/client/utils.py:176: in _wrapped
    return func(*args, params=params, headers=headers, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        api_key    = None
        args       = (&lt;opensearchpy.client.indices.IndicesClient object at 0x7f9c32cd80e0&gt;,)
        func       = &lt;function IndicesClient.flush at 0x7f9c33daac00&gt;
        headers    = {}
        http_auth  = None
        kwargs     = {'index': 'records-default-v1.0.0'}
        opensearch_query_params = ('allow_no_indices',
 'error_trace',
 'expand_wildcards',
 'filter_path',
 'force',
 'human',
 'ignore_unavailable',
 'pretty',
 'source',
 'wait_if_ongoing')
        p          = 'filter_path'
        params     = {'wait_if_ongoing': b'true'}
        v          = True
.venv/lib/python3.12/site-packages/opensearchpy/client/indices.py:186: in flush
    return self.transport.perform_request(
        headers    = {}
        index      = 'records-default-v1.0.0'
        params     = {'wait_if_ongoing': b'true'}
        self       = &lt;opensearchpy.client.indices.IndicesClient object at 0x7f9c32cd80e0&gt;
.venv/lib/python3.12/site-packages/opensearchpy/transport.py:457: in perform_request
    raise e
        attempt    = 0
        body       = None
        connection = &lt;Urllib3HttpConnection: http://localhost:9200&gt;
        headers    = {}
        ignore     = ()
        method     = 'POST'
        params     = {'wait_if_ongoing': b'true'}
        retry      = False
        self       = &lt;opensearchpy.transport.Transport object at 0x7f9c32cd83b0&gt;
        timeout    = None
        url        = '/records-default-v1.0.0/_flush'
.venv/lib/python3.12/site-packages/opensearchpy/transport.py:418: in perform_request
    status, headers_response, data = connection.perform_request(
        attempt    = 0
        body       = None
        connection = &lt;Urllib3HttpConnection: http://localhost:9200&gt;
        headers    = {}
        ignore     = ()
        method     = 'POST'
        params     = {'wait_if_ongoing': b'true'}
        retry      = False
        self       = &lt;opensearchpy.transport.Transport object at 0x7f9c32cd83b0&gt;
        timeout    = None
        url        = '/records-default-v1.0.0/_flush'
.venv/lib/python3.12/site-packages/opensearchpy/connection/http_urllib3.py:308: in perform_request
    self._raise_error(
        body       = None
        duration   = 0.0026280879974365234
        full_url   = 'http://localhost:9200/records-default-v1.0.0/_flush?wait_if_ongoing=true'
        headers    = {}
        ignore     = ()
        kw         = {}
        method     = 'POST'
        orig_body  = None
        params     = {'wait_if_ongoing': b'true'}
        raw_data   = ('{"error":{"root_cause":[{"type":"index_not_found_exception","reason":"no '
 'such index '
 '[records-default-v1.0.0]","index":"records-default-v1.0.0","resource.id":"records-default-v1.0.0","resource.type":"index_or_alias","index_uuid":"_na_"}],"type":"index_not_found_exception","reason":"no '
 'such index '
 '[records-default-v1.0.0]","index":"records-default-v1.0.0","resource.id":"records-default-v1.0.0","resource.type":"index_or_alias","index_uuid":"_na_"},"status":404}')
        request_headers = {'connection': 'keep-alive',
 'content-type': 'application/json',
 'user-agent': 'opensearch-py/2.8.0 (Python 3.12.12)'}
        response   = &lt;urllib3.response.HTTPResponse object at 0x7f9c32cd9b70&gt;
        self       = &lt;Urllib3HttpConnection: http://localhost:9200&gt;
        start      = 1763465918.0050776
        timeout    = None
        url        = '/records-default-v1.0.0/_flush?wait_if_ongoing=true'
        warning_headers = ()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = &lt;Urllib3HttpConnection: http://localhost:9200&gt;, status_code = 404
raw_data = '{"error":{"root_cause":[{"type":"index_not_found_exception","reason":"no such index [records-default-v1.0.0]","index"...ult-v1.0.0","resource.id":"records-default-v1.0.0","resource.type":"index_or_alias","index_uuid":"_na_"},"status":404}'
content_type = 'application/json'

    def _raise_error(
        self,
        status_code: int,
        raw_data: Union[str, bytes],
        content_type: Optional[str] = None,
    ) -&gt; None:
        """Locate appropriate exception and raise it."""
        error_message = raw_data
        additional_info = None
        try:
            content_type = (
                "text/plain"
                if content_type is None
                else content_type.split(";")[0].strip()
            )
            if raw_data and content_type == "application/json":
                additional_info = json.loads(raw_data)
                error_message = additional_info.get("error", error_message)
                if isinstance(error_message, dict) and "type" in error_message:
                    error_message = error_message["type"]
        except (ValueError, TypeError) as err:
            logger.warning("Undecodable raw error response from server: %s", err)
    
&gt;       raise HTTP_EXCEPTIONS.get(status_code, TransportError)(
            status_code, error_message, additional_info
        )
E       opensearchpy.exceptions.NotFoundError: NotFoundError(404, 'index_not_found_exception', 'no such index [records-default-v1.0.0]', records-default-v1.0.0, index_or_alias)

additional_info = {'error': {'index': 'records-default-v1.0.0',
           'index_uuid': '_na_',
           'reason': 'no such index [records-default-v1.0.0]',
           'resource.id': 'records-default-v1.0.0',
           'resource.type': 'index_or_alias',
           'root_cause': [{'index': 'records-default-v1.0.0',
                           'index_uuid': '_na_',
                           'reason': 'no such index [records-default-v1.0.0]',
                           'resource.id': 'records-default-v1.0.0',
                           'resource.type': 'index_or_alias',
                           'type': 'index_not_found_exception'}],
           'type': 'index_not_found_exception'},
 'status': 404}
content_type = 'application/json'
error_message = 'index_not_found_exception'
raw_data   = ('{"error":{"root_cause":[{"type":"index_not_found_exception","reason":"no '
 'such index '
 '[records-default-v1.0.0]","index":"records-default-v1.0.0","resource.id":"records-default-v1.0.0","resource.type":"index_or_alias","index_uuid":"_na_"}],"type":"index_not_found_exception","reason":"no '
 'such index '
 '[records-default-v1.0.0]","index":"records-default-v1.0.0","resource.id":"records-default-v1.0.0","resource.type":"index_or_alias","index_uuid":"_na_"},"status":404}')
self       = &lt;Urllib3HttpConnection: http://localhost:9200&gt;
status_code = 404

.venv/lib/python3.12/site-packages/opensearchpy/connection/base.py:315: NotFoundError</failure></testcase><testcase classname="tests.test_cli" name="test_queues_options" time="0.209" /><testcase classname="tests.test_invenio_indexer" name="ISORT" time="0.038" /><testcase classname="tests.test_invenio_indexer" name="black" time="0.198" /><testcase classname="tests.test_invenio_indexer" name="test_version" time="0.001" /><testcase classname="tests.test_invenio_indexer" name="test_init" time="0.005" /><testcase classname="tests.test_invenio_indexer" name="test_hook_initialization" time="0.122"><failure message="ValueError: Not naive datetime (tzinfo is already set)">base_app = &lt;Flask 'testapp'&gt;

    def test_hook_initialization(base_app):
        """Test hook initialization."""
        app = base_app
        magic_hook = MagicMock()
        app.config["INDEXER_BEFORE_INDEX_HOOKS"] = [
            magic_hook,
            "test_invenio_indexer:_global_magic_hook",
        ]
        ext = InvenioIndexer(app)
    
        with app.app_context():
            recid = uuid.uuid4()
            record = Record.create({"title": "Test"}, id_=recid)
            db.session.commit()
    
            client_mock = MagicMock()
&gt;           RecordIndexer(search_client=client_mock, version_type="force").index(record)

app        = &lt;Flask 'testapp'&gt;
base_app   = &lt;Flask 'testapp'&gt;
client_mock = &lt;MagicMock id='140308843927920'&gt;
ext        = &lt;invenio_indexer.ext.InvenioIndexer object at 0x7f9c32aca150&gt;
magic_hook = &lt;MagicMock id='140308843928880'&gt;
recid      = UUID('d9b5cc65-4c49-4210-9496-0db30f0c8307')
record     = {'title': 'Test'}

tests/test_invenio_indexer.py:64: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_indexer/api.py:178: in index
    body = self._prepare_record(record, index, arguments, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        arguments  = {}
        index      = 'records-default-v1.0.0'
        kwargs     = {}
        record     = {'title': 'Test'}
        self       = &lt;invenio_indexer.api.RecordIndexer object at 0x7f9c32a99010&gt;
invenio_indexer/api.py:472: in _prepare_record
    pytz.utc.localize(record.created).isoformat() if record.created else None
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        arguments  = {}
        data       = {'title': 'Test'}
        index      = 'records-default-v1.0.0'
        kwargs     = {}
        record     = {'title': 'Test'}
        self       = &lt;invenio_indexer.api.RecordIndexer object at 0x7f9c32a99010&gt;
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = &lt;UTC&gt;
dt = datetime.datetime(2025, 11, 18, 11, 38, 38, 634699, tzinfo=datetime.timezone.utc)
is_dst = False

    def localize(self, dt, is_dst=False):
        '''Convert naive time to local time'''
        if dt.tzinfo is not None:
&gt;           raise ValueError('Not naive datetime (tzinfo is already set)')
E           ValueError: Not naive datetime (tzinfo is already set)

dt         = datetime.datetime(2025, 11, 18, 11, 38, 38, 634699, tzinfo=datetime.timezone.utc)
is_dst     = False
self       = &lt;UTC&gt;

.venv/lib/python3.12/site-packages/pytz/__init__.py:245: ValueError</failure></testcase><testcase classname="tests.test_invenio_indexer" name="test_index_prefixing" time="0.182"><failure message="ValueError: Not naive datetime (tzinfo is already set)">base_app = &lt;Flask 'testapp'&gt;

    def test_index_prefixing(base_app):
        """Test index prefixing."""
        app = base_app
        app.config["INDEXER_REPLACE_REFS"] = False
        app.config["SEARCH_INDEX_PREFIX"] = "test-"
        ext = InvenioIndexer(app)
    
        default_index = app.config["INDEXER_DEFAULT_INDEX"]
    
        with app.app_context():
            with patch("invenio_records.api._records_state.validate"):
                record = Record.create({"title": "Test"})
                record2 = Record.create(
                    {
                        "$schema": "/records/authorities/authority-v1.0.0.json",
                        "title": "Test with schema",
                    }
                )
                record3 = Record.create({"title": "Test"})
                record3.delete()
            db.session.commit()
    
            with patch(
                "invenio_indexer.signals.before_record_index.send"
            ) as before_record_index_send:
                client_mock = MagicMock()
&gt;               RecordIndexer(search_client=client_mock).index(record)

app        = &lt;Flask 'testapp'&gt;
base_app   = &lt;Flask 'testapp'&gt;
before_record_index_send = &lt;MagicMock name='send' id='140308855372496'&gt;
client_mock = &lt;MagicMock id='140308841480064'&gt;
default_index = 'records-default-v1.0.0'
ext        = &lt;invenio_indexer.ext.InvenioIndexer object at 0x7f9c32cd0530&gt;
record     = {'title': 'Test'}
record2    = {'$schema': '/records/authorities/authority-v1.0.0.json',
 'title': 'Test with schema'}
record3    = {'title': 'Test'}

tests/test_invenio_indexer.py:117: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_indexer/api.py:178: in index
    body = self._prepare_record(record, index, arguments, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        arguments  = {}
        index      = 'records-default-v1.0.0'
        kwargs     = {}
        record     = {'title': 'Test'}
        self       = &lt;invenio_indexer.api.RecordIndexer object at 0x7f9c337cd100&gt;
invenio_indexer/api.py:472: in _prepare_record
    pytz.utc.localize(record.created).isoformat() if record.created else None
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        arguments  = {}
        data       = {'title': 'Test'}
        index      = 'records-default-v1.0.0'
        kwargs     = {}
        record     = {'title': 'Test'}
        self       = &lt;invenio_indexer.api.RecordIndexer object at 0x7f9c337cd100&gt;
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = &lt;UTC&gt;
dt = datetime.datetime(2025, 11, 18, 11, 38, 38, 811069, tzinfo=datetime.timezone.utc)
is_dst = False

    def localize(self, dt, is_dst=False):
        '''Convert naive time to local time'''
        if dt.tzinfo is not None:
&gt;           raise ValueError('Not naive datetime (tzinfo is already set)')
E           ValueError: Not naive datetime (tzinfo is already set)

dt         = datetime.datetime(2025, 11, 18, 11, 38, 38, 811069, tzinfo=datetime.timezone.utc)
is_dst     = False
self       = &lt;UTC&gt;

.venv/lib/python3.12/site-packages/pytz/__init__.py:245: ValueError</failure></testcase><testcase classname="tests.test_registry" name="ISORT" time="0.011" /><testcase classname="tests.test_registry" name="black" time="0.165" /><testcase classname="tests.test_registry" name="test_indexer_registry" time="0.089" /><testcase classname="tests.test_tasks" name="ISORT" time="0.010" /><testcase classname="tests.test_tasks" name="black" time="0.183" /><testcase classname="tests.test_tasks" name="test_process_bulk_queue" time="0.097" /><testcase classname="tests.test_tasks" name="test_index_record" time="0.093" /><testcase classname="tests.test_tasks" name="test_delete_record" time="0.090" /><testcase classname="tests.test_utils" name="ISORT" time="0.014" /><testcase classname="tests.test_utils" name="black" time="0.179" /><testcase classname="tests.test_utils" name="test_schema_to_index_with_names" time="0.093" /><testcase classname="tests.test_utils" name="test_schema_to_index[records/record-v1.0.0.json-records-record-v1.0.0-None]" time="0.105" /><testcase classname="tests.test_utils" name="test_schema_to_index[/records/record-v1.0.0.json-records-record-v1.0.0-None]" time="0.096" /><testcase classname="tests.test_utils" name="test_schema_to_index[default-v1.0.0.json-default-v1.0.0-None]" time="0.090" /><testcase classname="tests.test_utils" name="test_schema_to_index[default-v1.0.0.json-None-index_names3]" time="0.091" /><testcase classname="tests.test_utils" name="test_schema_to_index[invalidextension-None-None]" time="0.090" /><testcase classname="invenio_indexer.__init__" name="PYDOCSTYLE" time="0.005" /><testcase classname="invenio_indexer.__init__" name="ISORT" time="0.019" /><testcase classname="invenio_indexer.__init__" name="black" time="0.185" /><testcase classname="invenio_indexer.__init__" name="invenio_indexer" time="0.116"><failure message="068 Now, let's index the record. By default, records are sent to the search engine&#10;069 index defined by the configuration variable ``INDEXER_DEFAULT_INDEX``. This&#10;070 is set to ``None`` by default, to enforce that you always have to specify the&#10;071 index when indexing a record. For now let's set it to a default value and index&#10;072 the record:&#10;073 &#10;074 &gt;&gt;&gt; app.config['INDEXER_DEFAULT_INDEX'] = &quot;records-record-v1.0.0&quot;&#10;075 &gt;&gt;&gt; from invenio_indexer.api import RecordIndexer&#10;076 &gt;&gt;&gt; indexer = RecordIndexer()&#10;077 &gt;&gt;&gt; res = indexer.index(record)&#10;UNEXPECTED EXCEPTION: ValueError('Not naive datetime (tzinfo is already set)')&#10;Traceback (most recent call last):&#10;  File &quot;/opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/doctest.py&quot;, line 1368, in __run&#10;    exec(compile(example.source, filename, &quot;single&quot;,&#10;  File &quot;&lt;doctest invenio_indexer[22]&gt;&quot;, line 1, in &lt;module&gt;&#10;  File &quot;/home/runner/work/invenio-bug-verification/invenio-bug-verification/package-repo/invenio_indexer/api.py&quot;, line 178, in index&#10;    body = self._prepare_record(record, index, arguments, **kwargs)&#10;           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^&#10;  File &quot;/home/runner/work/invenio-bug-verification/invenio-bug-verification/package-repo/invenio_indexer/api.py&quot;, line 472, in _prepare_record&#10;    pytz.utc.localize(record.created).isoformat() if record.created else None&#10;    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^&#10;  File &quot;/home/runner/work/invenio-bug-verification/invenio-bug-verification/package-repo/.venv/lib/python3.12/site-packages/pytz/__init__.py&quot;, line 245, in localize&#10;    raise ValueError('Not naive datetime (tzinfo is already set)')&#10;ValueError: Not naive datetime (tzinfo is already set)&#10;/home/runner/work/invenio-bug-verification/invenio-bug-verification/package-repo/invenio_indexer/__init__.py:77: UnexpectedException">068 Now, let's index the record. By default, records are sent to the search engine
069 index defined by the configuration variable ``INDEXER_DEFAULT_INDEX``. This
070 is set to ``None`` by default, to enforce that you always have to specify the
071 index when indexing a record. For now let's set it to a default value and index
072 the record:
073 
074 &gt;&gt;&gt; app.config['INDEXER_DEFAULT_INDEX'] = "records-record-v1.0.0"
075 &gt;&gt;&gt; from invenio_indexer.api import RecordIndexer
076 &gt;&gt;&gt; indexer = RecordIndexer()
077 &gt;&gt;&gt; res = indexer.index(record)
UNEXPECTED EXCEPTION: ValueError('Not naive datetime (tzinfo is already set)')
Traceback (most recent call last):
  File "/opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/doctest.py", line 1368, in __run
    exec(compile(example.source, filename, "single",
  File "&lt;doctest invenio_indexer[22]&gt;", line 1, in &lt;module&gt;
  File "/home/runner/work/invenio-bug-verification/invenio-bug-verification/package-repo/invenio_indexer/api.py", line 178, in index
    body = self._prepare_record(record, index, arguments, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/invenio-bug-verification/invenio-bug-verification/package-repo/invenio_indexer/api.py", line 472, in _prepare_record
    pytz.utc.localize(record.created).isoformat() if record.created else None
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/invenio-bug-verification/invenio-bug-verification/package-repo/.venv/lib/python3.12/site-packages/pytz/__init__.py", line 245, in localize
    raise ValueError('Not naive datetime (tzinfo is already set)')
ValueError: Not naive datetime (tzinfo is already set)
/home/runner/work/invenio-bug-verification/invenio-bug-verification/package-repo/invenio_indexer/__init__.py:77: UnexpectedException</failure></testcase><testcase classname="invenio_indexer.api" name="PYDOCSTYLE" time="0.048" /><testcase classname="invenio_indexer.api" name="ISORT" time="0.079" /><testcase classname="invenio_indexer.api" name="black" time="0.249" /><testcase classname="invenio_indexer.cli" name="PYDOCSTYLE" time="0.017" /><testcase classname="invenio_indexer.cli" name="ISORT" time="0.036" /><testcase classname="invenio_indexer.cli" name="black" time="0.211" /><testcase classname="invenio_indexer.config" name="PYDOCSTYLE" time="0.003" /><testcase classname="invenio_indexer.config" name="ISORT" time="0.012" /><testcase classname="invenio_indexer.config" name="black" time="0.163" /><testcase classname="invenio_indexer.ext" name="PYDOCSTYLE" time="0.008" /><testcase classname="invenio_indexer.ext" name="ISORT" time="0.014" /><testcase classname="invenio_indexer.ext" name="black" time="0.192" /><testcase classname="invenio_indexer.proxies" name="PYDOCSTYLE" time="0.003" /><testcase classname="invenio_indexer.proxies" name="ISORT" time="0.009" /><testcase classname="invenio_indexer.proxies" name="black" time="0.174" /><testcase classname="invenio_indexer.registry" name="PYDOCSTYLE" time="0.005" /><testcase classname="invenio_indexer.registry" name="ISORT" time="0.008" /><testcase classname="invenio_indexer.registry" name="black" time="0.164" /><testcase classname="invenio_indexer.signals" name="PYDOCSTYLE" time="0.005" /><testcase classname="invenio_indexer.signals" name="ISORT" time="0.014" /><testcase classname="invenio_indexer.signals" name="black" time="0.190" /><testcase classname="invenio_indexer.tasks" name="PYDOCSTYLE" time="0.007" /><testcase classname="invenio_indexer.tasks" name="ISORT" time="0.013" /><testcase classname="invenio_indexer.tasks" name="black" time="0.173" /><testcase classname="invenio_indexer.utils" name="PYDOCSTYLE" time="0.006" /><testcase classname="invenio_indexer.utils" name="ISORT" time="0.015" /><testcase classname="invenio_indexer.utils" name="black" time="0.170" /></testsuite></testsuites>